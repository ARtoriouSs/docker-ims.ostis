# Dockerized ims.ostis

Это инструкция по запску OSTIS в [Docker](https://www.docker.com/ "Docker") контейнере.  
Для начала, зачем это нужно: Если по каким-то причинам система не запускается в установленной операционке, можно запустить её в изолированном контейнере, для этого нужно просто установить Docker и скопипастить команды ниже. Таким же образом можно запустить суперинтеллектуальную систему с винды, поставить докер на окна намного проще чем остис. Это схоже с запуском на виртуалке, но требует меньше памяти и в общем случае намного быстрее чем ставить полноценную виртуалку. Плюс должно работать ну прям 99% и никаких настроек вручную, просто копипаста команд ниже :) Постараюсь всё расписать подробно, чтобы было понятнее, но если всё плохо, то в конце будет краткий гуид. Итак:

## Установка и запуск

**Шаг 0**

Нужно установить Docker:

* [Для Linux](https://www.digitalocean.com/community/tutorials/docker-ubuntu-16-04-ru "Установка Docker на Ubuntu")

* [Для Windows 10](https://hub.docker.com/editions/community/docker-ce-desktop-windows "Установка Docker на Windows 10") или [для старых Windows](https://docs.docker.com/toolbox/overview/ "Установка Docker на старых Windows")

Если с установкой по ссылкам что-то неясно, можно просто загуглить, там всё просто.  
Далее просто выполняем следующие команды (для шиндовс это лучше делать в bash эмуляторе типо [GitBash](https://gitforwindows.org/ "GitBash")):

**Шаг 1**

Сначала нужно скинуть всё что должно быть в базе в одну любую папку, затем зайти в эту папку в терминале, эти файлы будут скопированы в контейнер (скорее всего это будет папка kb):
```bash
cd ostis/kb # или cd абсолютно/любая/папка/в/которой/лежат/файлы/базы
```

**Важно!** Эта папка не должна быть совсем пустой. Если хочется просто проверить заработает ли, можно создать любой файлик: ```touch .keep```.

**Шаг 2**

Собираем образ из Dockerfile'a в этом репозитории. Клонировать его себе не обязательно.  
Тут есть два варианта: первый стянет [мой образ из DockerHub'а](https://cloud.docker.com/u/artorious/repository/docker/artorious/ostis "DockerHub") и обновит все сабмодули, второй обновлять не будет. В первом случае контейнер будет использовать последнюю версию системы, но бывало такое что на репозитории заливались изменения которые что-то ломают. Для этого случая тут и есть второй вариант: он почти 100% запустит всё как нужно, но есть вероятность, что когда-нибудь на эти сабмодули зальют что-нибудь важное и получится так, что этот вариант будет разворачивать неактуальную версию системы.  
После обновления (или его отстутствия) оба варианта скопируют всё что есть в текущей директории в папку kb в контейнере, для этого и был нужен предыдущий шаг.  
Штош, первый вариант с обновлениями:
```bash
curl https://raw.githubusercontent.com/ARtoriouSs/docker-ims.ostis/master/Dockerfile | docker build --pull --tag ostis --file - .
```

Или второй, без обновлений, если первый не работает:
```bash
curl https://raw.githubusercontent.com/ARtoriouSs/docker-ims.ostis/master/Dockerfile.noupdate | docker build --pull --tag ostis --file - .
```

В первый раз он будет скачивать около двух гигов ~вирусов~, в последующих запусках всё будет намного быстрее. Если всё хорошо в конце должны быть строчки Successfully built 3f9b004f0108 и Successfully tagged ostis:latest.

**Шаг 3**

Теперь у нас есть созданный локально образ, который называется ostis, это можно проверить выполнив ```docker images```, должно быть два образа artorious/ostis с пустым остисом из DockerHub'а и ostis собранный из докерфайла, который теперь нужно запустить, заэкспоузив порт 8000:
```bash
docker run -p 8000:8000/tcp ostis bash -c "./run.sh"
```

Эта команда создаст контейнер из созданного образа ostis, перенаправит порт 8000 контейнера на локальную машину и запустит внутри этого контейнера скрипт run.sh, в котором просто запускается redis-server, restart_sctp.sh и run_scweb.sh. Весь вывод этих команд будет виден в консоли, то есть если есть какие-то ошибки при сборке базы, их можно как обычно найти там. После этого нужно немного подождать пока там всё запустится и всё, теперь остис слушает localhost:8000, можно зайти туда в браузере и потыкать, все скопированные фалы должны быть доступны в поиске.

**Шаг 4 или как всё это вырубить шоб оно не съело всю память после нескольких перезапусков**

Выходим из контейнера, нажав ctrl + C и написав ```exit```. Это может не работать в некоторых оболочках, если так, то открываем новый терминал (вкладку) и пишем:
```bash
docker rmi ostis & docker rmi $(docker images -f "dangling=true" -q) & docker rm -f $(docker ps -aq)
```

Команду нужно выполнить в любом случае, даже если ctrl + C сработал. Она удалит все контейнеры и собранный образ. Если очень хочется проверить, то ```docker ps -a``` покажет все контейнеры, они должны отсутствовать, а ```docker images``` покажет все образы, там должен остаться только базовый образ artorious/ostis. Если это всё слишком страшно (или бесполезно) и больше использоваться не будет, то можно выполнить ещё и ```docker system prune```, оно удалит вообще все образы и контейнеры, чтобы они не занимали память. Стоит помнить что каждый созданный контейнер и образ занмают память, и если не выполнять шаг 4, то будет бяка :(

Теперь можно внести изменения в свои файлы и выполнить всё сначала.

**Если всё выглядит страшно и непонятно, то вот то же самое но без пояснений:**

Собираем:
```bash
curl https://raw.githubusercontent.com/ARtoriouSs/docker-ims.ostis/master/Dockerfile | docker build --pull --tag ostis --file - .
```
Запускаем:
```bash
docker run -p 8000:8000/tcp ostis bash -c "./run.sh"
```
Смотрим чё как,  
Вырубаем:
```bash
docker rmi ostis & docker rmi $(docker images -f "dangling=true" -q) & docker rm -f $(docker ps -aq)
```
Вносим изменения в базу, снова собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем, собираем, запускаем, вырубаем...

**P.S.** Автор идеи [Маша](https://github.com/idealasgas "GitHub Маши") :)
